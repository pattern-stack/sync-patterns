# Entity Generator Import Dependencies - Fix Report

## Problem Summary

The entity generator (`src/generators/entity-generator.ts`) outputs code that references files that may not exist depending on which CLI flags are used. This could cause TypeScript compilation errors in the generated code.

## Root Cause Analysis

### Generated Import Dependencies

The entity generator creates wrapper files in `src/generated/entities/` that import from:

1. `../../schemas/index.js` - **ALWAYS imported** (lines 345, 353, 392)
2. `../../hooks/index.js` - **ALWAYS imported** (lines 371, 387)
3. `../../config.js` - **CONDITIONALLY imported** when `hasCollection = true` (line 381)
4. `../../collections/{entity}.js` - **CONDITIONALLY imported** when `hasCollection = true` (line 383)
5. `../types.js` - **ALWAYS imported** (line 395) - This IS generated by entity generator itself âœ…

### Existing Generator Behavior

- **zod-generator.ts**: Generates `schemas/index.ts` (barrel export) âœ…
- **hook-generator.ts**: Generates `hooks/index.ts` (barrel export) âœ…
- **collection-generator.ts**: Generates `collections/index.ts` (barrel export) âœ…
- **config-generator.ts**: Generates `config.ts` (runtime config) âœ…
- **entity-generator.ts**: Generates `entities/types.ts` (shared types) âœ…

### CLI Flags and Dependencies

```bash
--schemas      (default: true)   â†’ Creates schemas/index.ts
--hooks        (default: true)   â†’ Creates hooks/index.ts
--collections  (default: false)  â†’ Creates collections/index.ts + config.ts
--entities     (default: false)  â†’ Creates entities/*.ts + entities/types.ts
```

### The Problem

If a user runs:
```bash
sync-patterns generate spec.json --entities --no-schemas
```

Or:
```bash
sync-patterns generate spec.json --entities --no-hooks
```

The generated entity files would import from `schemas/index.js` or `hooks/index.js` which don't exist, causing compilation errors.

## Solution Implemented

Added dependency validation in `/Users/dug/pattern-stack-workspace/sync-patterns/src/cli/commands/generate.ts` (lines 202-221):

```typescript
// Generate unified entity wrappers
if (options.entities) {
  // Validate dependencies
  if (!options.schemas) {
    console.error('âŒ Error: --entities requires --schemas to be enabled')
    console.error('   Entity wrappers import types from schemas/index.ts')
    process.exit(1)
  }
  if (!options.hooks) {
    console.error('âŒ Error: --entities requires --hooks to be enabled')
    console.error('   Entity wrappers import hooks from hooks/index.ts')
    process.exit(1)
  }

  // Check if any endpoint has local_first: true
  const hasLocalFirstEndpoints = parsed.endpoints.some(e => e.localFirst === true)
  if (hasLocalFirstEndpoints && !options.collections) {
    console.error('âŒ Error: --entities requires --collections when local_first endpoints exist')
    console.error('   Entity wrappers import from config.ts and collections/ for local_first entities')
    console.error('   Found endpoints with local_first: true in the OpenAPI spec')
    process.exit(1)
  }

  // ... continue with generation
}
```

## Why This Fix is Correct

### 1. Import Paths are Valid

The entity generator uses correct TypeScript ES module import conventions:
- Imports `.js` extensions even though source files are `.ts`
- This is required by `"moduleResolution": "node16"` or `"bundler"`
- All relative paths from `entities/*.ts` are correct:
  - `../../schemas/index.js` â†’ `schemas/index.ts` âœ…
  - `../../hooks/index.js` â†’ `hooks/index.ts` âœ…
  - `../../config.js` â†’ `config.ts` âœ…
  - `../../collections/*.js` â†’ `collections/*.ts` âœ…
  - `../types.js` â†’ `entities/types.ts` âœ…

### 2. Barrel Exports Exist

Both zod-generator and hook-generator create `index.ts` barrel exports:
- `zod-generator.ts` line 359-377: `generateIndexFile()`
- `hook-generator.ts` line 713-731: `generateIndexFile()`
- Both are written by `generate.ts` lines 112 and 162

### 3. Conditional Imports are Correct

The entity generator only imports from `config.ts` and `collections/` when `hasCollection = true`:
```typescript
if (hasCollection) {
  lines.push("import { isLocalFirst } from '../../config.js'")
  lines.push("import { useLiveQuery, eq } from '@tanstack/react-db'")
  lines.push(`import { ${this.toCamelCase(namePlural)}Collection } from '../../collections/${this.toKebabCase(namePlural)}.js'`)
}
```

This is safe because our validation ensures `--collections` is enabled when `local_first: true` endpoints exist.

## Directory Structure

```
src/generated/
â”œâ”€â”€ schemas/
â”‚   â”œâ”€â”€ index.ts       â† Required by entities (barrel export)
â”‚   â””â”€â”€ *.schema.ts
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ index.ts       â† Required by entities (barrel export)
â”‚   â”œâ”€â”€ queries.ts
â”‚   â”œâ”€â”€ mutations.ts
â”‚   â”œâ”€â”€ keys.ts
â”‚   â””â”€â”€ types.ts
â”œâ”€â”€ collections/       â† Only if --collections
â”‚   â”œâ”€â”€ index.ts
â”‚   â””â”€â”€ *.ts
â”œâ”€â”€ entities/          â† Only if --entities
â”‚   â”œâ”€â”€ index.ts       â† Generated
â”‚   â”œâ”€â”€ types.ts       â† Generated (imported by entity files)
â”‚   â””â”€â”€ *.ts           â† Import from schemas/, hooks/, config, collections/
â”œâ”€â”€ client/
â”‚   â””â”€â”€ ...
â””â”€â”€ config.ts          â† Only if --collections
```

## Testing the Fix

### Valid Combinations

âœ… `sync-patterns generate spec.json`
   - Defaults: schemas=true, hooks=true, entities=false
   - No entity files generated, no issue

âœ… `sync-patterns generate spec.json --entities`
   - schemas=true (default), hooks=true (default), entities=true
   - All dependencies present
   - **TESTED**: Successfully generates all files

âœ… `sync-patterns generate spec.json --entities --collections`
   - All generators enabled
   - All dependencies present
   - **TESTED**: Successfully generates all files including config.ts and collections/

### Invalid Combinations (Now Prevented)

âŒ `sync-patterns generate spec.json --entities --no-schemas`
   - Error: "âŒ Error: --entities requires --schemas to be enabled"
   - Prevents missing `schemas/index.ts`
   - **TESTED**: Validation correctly prevents generation

âŒ `sync-patterns generate spec.json --entities --no-hooks`
   - Error: "âŒ Error: --entities requires --hooks to be enabled"
   - Prevents missing `hooks/index.ts`
   - **TESTED**: Validation correctly prevents generation

âŒ `sync-patterns generate spec.json --entities` (when spec has `local_first: true`)
   - Error: "âŒ Error: --entities requires --collections when local_first endpoints exist"
   - Prevents missing `config.ts` and `collections/`
   - **TESTED**: Validation correctly prevents generation

### Test Results

All validation tests passed:

```bash
# Test 1: Missing schemas
$ node dist/cli/index.js generate test-spec.json --entities --no-schemas
âŒ Error: --entities requires --schemas to be enabled
   Entity wrappers import types from schemas/index.ts

# Test 2: Missing hooks
$ node dist/cli/index.js generate test-spec.json --entities --no-hooks
âŒ Error: --entities requires --hooks to be enabled
   Entity wrappers import hooks from hooks/index.ts

# Test 3: Missing collections (with local_first endpoint)
$ node dist/cli/index.js generate test-spec-local-first.json --entities
âŒ Error: --entities requires --collections when local_first endpoints exist
   Entity wrappers import from config.ts and collections/ for local_first entities
   Found endpoints with local_first: true in the OpenAPI spec

# Test 4: All dependencies present
$ node dist/cli/index.js generate test-spec-local-first.json --entities --collections
âœ… Generation complete!
ğŸ“¦ Generated files in: /tmp/test-output4
```

Generated files structure (verified):
```
/tmp/test-output4/
â”œâ”€â”€ client/
â”‚   â”œâ”€â”€ client.ts
â”‚   â”œâ”€â”€ config.ts
â”‚   â”œâ”€â”€ index.ts
â”‚   â”œâ”€â”€ methods.ts
â”‚   â””â”€â”€ types.ts
â”œâ”€â”€ collections/
â”‚   â”œâ”€â”€ contacts.ts       â† Collection for local_first entity
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ entities/
â”‚   â”œâ”€â”€ contacts.ts       â† Imports from schemas/, hooks/, config, collections/
â”‚   â”œâ”€â”€ index.ts
â”‚   â””â”€â”€ types.ts
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ index.ts          â† Required barrel export âœ…
â”‚   â”œâ”€â”€ keys.ts
â”‚   â”œâ”€â”€ mutations.ts
â”‚   â”œâ”€â”€ queries.ts
â”‚   â””â”€â”€ types.ts
â”œâ”€â”€ schemas/
â”‚   â””â”€â”€ index.ts          â† Required barrel export âœ…
â””â”€â”€ config.ts             â† Required for local_first âœ…
```

## Build Verification

```bash
npm run build
```

Output:
```
âœ… Build success in 782ms
```

No TypeScript errors, all modules compiled successfully.

## Files Modified

1. `/Users/dug/pattern-stack-workspace/sync-patterns/src/cli/commands/generate.ts`
   - Added dependency validation (lines 202-221)
   - Checks schemas, hooks, and collections dependencies before generating entities

2. `/Users/dug/pattern-stack-workspace/sync-patterns/src/cli/index.ts`
   - Modified CLI option definitions (lines 24-31)
   - Added `--no-schemas`, `--no-client`, `--no-hooks` flags for explicit negation
   - Changed boolean options to support negation syntax

## Conclusion

The entity generator was already correctly designed with:
- Proper import paths
- Conditional imports for optional features (collections)
- Reliance on barrel exports from schemas and hooks

The issue was lack of CLI validation to ensure required generators were enabled. The fix adds explicit dependency checking with clear error messages, preventing users from generating invalid code.

No changes were needed to the entity generator itself - it was working correctly. The fix is purely in the CLI command validation layer.
